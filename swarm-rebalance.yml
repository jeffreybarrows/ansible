---
- name: Force rebalance of Docker Swarm services
  hosts: all
  become: yes
  tasks:
    - name: Get the list of Docker Swarm nodes and their details
      ansible.builtin.shell: docker node ls --format '{{{{json .}}}}'
      register: docker_nodes
      changed_when: false

    - name: Parse node details and drain worker nodes
      ansible.builtin.shell: docker node update --availability drain {{ item.ID }}
      loop: "{{ docker_nodes.stdout_lines | map('from_json') | list }}"
      when: item.Role == 'worker'

    - name: Set manager node to drain to prevent scheduling of services unless needed
      ansible.builtin.shell: docker node update --availability drain {{ item.ID }}
      loop: "{{ docker_nodes.stdout_lines | map('from_json') | list }}"
      when: item.Role == 'manager'

    - name: Pause to allow services to migrate
      ansible.builtin.pause:
        seconds: 15

    - name: Bring worker nodes back online to rebalance services
      ansible.builtin.shell: docker node update --availability active {{ item.ID }}
      loop: "{{ docker_nodes.stdout_lines | map('from_json') | list }}"
      when: item.Role == 'worker'

    - name: Bring manager node back online for backup
      ansible.builtin.shell: docker node update --availability active {{ item.ID }}
      loop: "{{ docker_nodes.stdout_lines | map('from_json') | list }}"
      when: item.Role == 'manager'
